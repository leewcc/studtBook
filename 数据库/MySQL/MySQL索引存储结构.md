# MySQL 的索引机制
MySQL 常见的索引有 B+树索引、哈希索引和全文索引

Memory 引擎默认使用哈希索引，对每一个 key 通过 hash 来定位获取，该种索引不支持范围查询和排序

## B+树索引
在 innodb 中，默认的索引结构是 B+ 树索引，B+树索引的特点是，所有非叶子节点只存储键值，不存储数据， 叶子节点则存放了实际的数据，并且每个叶子节点通过指针连接，能够快速进行范围查询

### 聚簇索引与非聚簇索引
聚簇索引是指在 B+ 树索引中，叶子节点存储的是数据行记录的指针，而非聚簇索引叶子节点存储的是主键 id，对于查询需要先查到主键 id，再通过主键索引表查到对应的数据行记录。

**聚簇索引**
innodb 每一张表有且只有一个聚簇索引，其他的索引都是非聚簇索引（辅助索引）；MyLSAM 所有索引都是非聚簇索引

聚簇索引的建议：
- 如果含有主键，且主键每列都是 not null 且 auto increment，则该主键索引为聚簇索引
- 如果没有主键，但是存在唯一索引每列是 not null 且 auto increment，则该唯一索引是聚簇索引
- 如果均不存在，则创建一个隐藏的主键，作为聚簇索引

聚簇索引的特点：
- 叶子节点直接存储行记录指针，避免了二次查询
- 插入慢，因为存储顺序与物理顺序一致，如果按顺序插入可能会很快，但是如果是中间插入或者更新组件，则有可能造成页面分裂，同时插入时还需要判断主键是否重复
- 节省空间，非聚簇索引需要存储二级索引表

### 索引的命中规则
1. where 条件中 有 or，则只会命中 or 前面条件的索引
2. like 以 % 开头的不会命中索引
3. 如果列是字符串类型，则需要使用 ''，不能直接类型转化
4. 索引列上使用函数
5. 使用 not in、not exist
6. 负向条件 !=
7. 最左前缀，

 
### 联合索引
联合索引又指多列索引，对于联合索引，存储结构是这样组成的：
每个节点存储了所有列的值，按照最左顺序来进行排序，第一列是全局有序的，而后面的列均为局部有序。

因此查询时，会按照最左原则优先匹配，最后定位到匹配的叶子节点，再回表查询对应的记录

**覆盖索引**
如果查询的数据均在索引上，则当前查询命中覆盖查询，直接从二级索引树上获取数据，不需要经过回表操作

**索引下推**
当只命中联合索引的部分列时，在 MySQL 5.6 版本增加了索引下推的机制，即对于不能使用索引，但是列属于索引里的条件查询或者模糊查询或者匹配单值的查询，均可以使用索引下推，先在引擎层完成过滤，再回表进行查询，从而减少回表查询的次数

适用于 range, ref, eq_ref, and ref_or_null 类型的查询

## 全文索引
MySQL 的全文索引只允许对 char、varchar、text 等类型字段的设置，设置了全文索引的列，MySQL 会对列中的分词统计出现次数，并记录出现的位置
哪些分词会命中：
- 分词不在默认不命中分词列表中
- 分词的字符长度要在  [min_token, max_token] 之间

检索模式
1. 自然语言模式：等价于匹配出现
2. boolean 模式：可通过增加修饰符匹配
	- \+ 必须包含该词
	- \- 必须不包含该词
	- \> 提高该词的相关性，查询的结果靠前
	- < 降低该词的相关性，查询的结果