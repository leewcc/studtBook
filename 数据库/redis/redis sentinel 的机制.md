# sentinel 哨兵
哨兵模式下，哨兵节点是一种特殊的 redis 节点，用于监听集群中主从的状态与自动化故障恢复

哨兵节点的基本概念
**定时任务**
每个哨兵节点维护了3个定时任务。分别是
1. 向主从节点发送 info 命令获取最新的主从结构
2. 发布订阅功能获取其他哨兵节点的信息
3. 向其他节点发送 ping 命令进行心跳检测，判断是否下线

**主观下线**
如果心跳检测的定时任务中，如果其他节点超过一定时间没有恢复，则哨兵节点认为其主观下线

**客观下线**
哨兵节点在对主节点进行主观下线后，会通过 sentinel is-master-down-by-addr 命令询问其他哨兵节点该主节点的状态，如果 {quorum} 个 哨兵节点都认为主节点下线，则对该主节点进行客观下线

{quorum} 为多少个哨兵节点认为主节点主观下线，则标记为客观下线，建议配置为哨兵集群节点数的一半 + 1

注：如果从节点被哨兵节点认为主观下线，是不会有后续的客户端下线和故障转移操作的

**选举领导者哨兵节点**
主节点被客观下线后，哨兵节点会选择出一个leader，由leader 进行故障转移
选举使用的 Raft 算法

** 故障转移
1. 在从节点选择新的主节点。选择原则：过滤掉不健康的从节点，选择优先级最高的从节点（slave-priority）；如果优先级无法区分，则选择偏移量最大的从节点；如果仍无法区分，则选择 runid最小的从节点
2. 更新主从状态，新主调用 slaveof no one；其他从节点通过 slaveof 绑定新主
3. 旧主也设置为新主的从节点

配置参数：
- sentinel monitor {masterName} {masterIp} {masterPort} {quorum}
> sentinel monitor是哨兵最核心的配置，在前文讲述部署哨兵节点时已说明，其中：masterName指定了主节点名称，masterIp和masterPort指定了主节点地址，quorum是判断主节点客观下线的哨兵数量阈值：当判定主节点下线的哨兵数量达到quorum时，对主节点进行客观下线。建议取值为哨兵数量的一半加1。

- sentinel down-after-milliseconds {masterName} {time}
> sentinel down-after-milliseconds与主观下线的判断有关：哨兵使用ping命令对其他节点进行心跳检测，如果其他节点超过down-after-milliseconds配置的时间没有回复，哨兵就会将其进行主观下线。该配置对主节点、从节点和哨兵节点的主观下线判定都有效。
down-after-milliseconds的默认值是30000，即30s；可以根据不同的网络环境和应用要求来调整：值越大，对主观下线的判定会越宽松，好处是误判的可能性小，坏处是故障发现和故障转移的时间变长，客户端等待的时间也会变长。例如，如果应用对可用性要求较高，则可以将值适当调小，当故障发生时尽快完成转移；如果网络环境相对较差，可以适当提高该阈值，避免频繁误判。

- sentinel parallel-syncs {masterName} {number}
> sentinel parallel-syncs与故障转移之后从节点的复制有关：它规定了每次向新的主节点发起复制操作的从节点个数。例如，假设主节点切换完成之后，有3个从节点要向新的主节点发起复制；如果parallel-syncs=1，则从节点会一个一个开始复制；如果parallel-syncs=3，则3个从节点会一起开始复制。
parallel-syncs取值越大，从节点完成复制的时间越快，但是对主节点的网络负载、硬盘负载造成的压力也越大；应根据实际情况设置。例如，如果主节点的负载较低，而从节点对服务可用的要求较高，可以适量增加parallel-syncs取值。parallel-syncs的默认值是1。

- sentinel failover-timeout {masterName} {time}
> sentinel failover-timeout与故障转移超时的判断有关，但是该参数不是用来判断整个故障转移阶段的超时，而是其几个子阶段的超时，例如如果主节点晋升从节点时间超过timeout，或从节点向新的主节点发起复制操作的时间(不包括复制数据的时间)超过timeout，都会导致故障转移超时失败。
failover-timeout的默认值是180000，即180s；如果超时，则下一次该值会变为原来的2倍。

**总结**
优点：
- 增加了主节点的故障转移，进一步提高了 Redis 的高可用性。

缺点：
- 无法对从节点进行自动故障转移；
- 无法解决写操作负载均衡的问题，存储能力受到单机限制的问题